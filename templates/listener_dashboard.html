
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Listener Dashboard | Isai Mini</title>

<style>
*{
    box-sizing:border-box;
    font-family:Segoe UI,sans-serif;
}

body{
    margin:0;
    background:linear-gradient(135deg,#87ceeb,#b0e0e6);
    color:#111;
}

.navbar{
    display:flex;
    justify-content:flex-end;
    gap:30px;
    padding:20px 40px;
    font-size:17px;
}

.navbar a{
    text-decoration:none;
    font-weight:700;
    color:#000;
}

.main{
    display:flex;
    padding:30px 40px;
    gap:40px;
}

.left{width:70%;}
.right{width:30%;}

.logo{
    font-size:26px;
    font-weight:800;
    margin-bottom:20px;
    background:linear-gradient(90deg,#1db954,#ff2d55);
    -webkit-background-clip:text;
    -webkit-text-fill-color:transparent;
}

.search-box{
    width:100%;
    padding:14px 22px;
    border-radius:30px;
    border:none;
    outline:none;
    font-size:15px;
    background:rgba(255,255,255,.7);
    backdrop-filter:blur(10px);
    margin-bottom:20px;
}

#searchResults{
    margin-bottom:20px;
}

#searchResults .song-card{
    display:flex;
    flex-direction:column;
    align-items:flex-start;
    gap:5px;
    padding:10px 15px;
    margin-bottom:10px;
    background:rgba(255,255,255,.55);
    border-radius:12px;
    cursor:pointer;
    transition:.3s;
}

#searchResults .song-card:hover{
    transform:translateY(-3px);
    background:rgba(255,255,255,.75);
}

h3{
    margin-bottom:15px;
    font-weight:700;
}

.card-row{
    display:flex;
    gap:25px;
    margin-bottom:35px;
    flex-wrap:wrap;
}

.song-card{
    width:120px;
    height:120px;
    border-radius:16px;
    background:rgba(255,255,255,.55);
    backdrop-filter:blur(12px);
    box-shadow:0 15px 30px rgba(0,0,0,.2);
    display:flex;
    justify-content:center;
    align-items:center;
    cursor:pointer;
    flex-direction:column;
    transition:.3s;
    text-align:center;
    padding:10px;
}

.song-card:hover{
    transform:translateY(-6px);
    box-shadow: 0 20px 40px rgba(0,0,0,.3);
    background: rgba(255,255,255,.75);
}

.lyrics-preview {
    font-size: 12px;
    color: #333;
    max-height: 50px;
    overflow: hidden;
    text-overflow: ellipsis;
    margin-top: 5px;
    text-align: center;
}

.playlist-box{
    display:flex;
    gap:20px;
    margin-bottom:30px;
    flex-wrap:wrap;
}

.create-btn{
    padding:12px 26px;
    border-radius:30px;
    border:none;
    cursor:pointer;
    font-weight:700;
    background:linear-gradient(90deg,#1db954,#ff2d55);
    color:#fff;
    transition:.3s;
}

.create-btn:hover{
    transform: scale(1.05);
    background: linear-gradient(90deg,#ff2d55,#1db954);
}

/* -------------------- MINI PLAYER -------------------- */
.player{
    position: fixed;
    bottom: 20px;
    right: 20px;
    width: 280px;
    background:rgba(0,0,0,.35);
    backdrop-filter:blur(14px);
    border-radius:20px;
    padding:20px;
    display:flex;
    flex-direction:column;
    justify-content:flex-end;
    box-shadow:0 25px 45px rgba(0,0,0,.35);
    z-index:1000;
}

.player-info{
    color:#fff;
    margin-bottom:10px;
}

.player-info .title{
    font-size:18px;
    font-weight:700;
    background: linear-gradient(90deg,#1db954,#ff2d55);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
}

.player-info .artist{
    font-size:14px;
    color:#ddd;
}

.player-lyrics{
    font-size:12px;
    color:#fff;
    max-height:80px;
    overflow-y:auto;
    margin-top:10px;
}

.player-controls{
    display:flex;
    justify-content:center;
    align-items:center;
    gap:20px;
    margin-top:10px;
}

.player-controls button{
    background:none;
    border:none;
    color:#fff;
    font-size:24px;
    cursor:pointer;
}

/* keep audio element tiny but functional */
audio{
    width:100%;
    opacity:0;
    height:0;
}
</style>
</head>

<body>

<div class="navbar">
    <a href="/playlist">Playlist</a>
    <a href="/favourite">Favourite</a>
    <a href="/logout">Logout</a>
</div>

<div class="main">

<div class="left">
    <div class="logo">Isai Mini</div>

    <input class="search-box" type="text" placeholder="Search for Artist or Song Name" oninput="searchSongs(this.value)">
    <div id="searchResults"></div>

    <h3>Newly Uploaded Songs</h3>
    <div class="card-row" id="recommendedSongs">
        {% for song in songs %}
        <div class="song-card" 
             data-src="{{ url_for('static', filename=song.file_path) }}"
             data-id="{{ song.id }}"
             data-title="{{ song.title }}"
             data-artist="{{ song.artist_name }}"
             data-lyrics="{{ song.lyrics|default('Lyrics not available') }}">
            <div>{{ song.title }}</div>
            <div class="lyrics-preview">{{ (song.lyrics or 'Lyrics not available')[:100] }}...</div>
        </div>
        {% endfor %}
    </div>

    <h3>Your Playlist</h3>
    <div class="playlist-box">
        {% for playlist in playlists %}
        <button class="create-btn" onclick="playPlaylist({{ playlist.id }})">
            {{ playlist.name }}
        </button>
        {% endfor %}
        <button class="create-btn" onclick="window.location.href='/create-playlist'">
            + Create Playlist
        </button>
    </div>
</div>

<div class="right">
    <div class="player">
        <div class="player-info">
            <div class="title" id="playerTitle">Select a song</div>
            <div class="artist" id="playerArtist"></div>
        </div>
        <div class="player-lyrics" id="playerLyrics"></div>
        <div class="player-controls">
            <button onclick="prevSong()">⏮</button>
            <button onclick="togglePlayPause()" id="playPauseBtn">▶</button>
            <button onclick="nextSong()">⏭</button>
        </div>
        <audio id="audioPlayer"></audio>
    </div>
</div>

</div>

<script>
let queue = [];
let currentIndex = 0;
let isPlaying = false;

/* Initialize queue after page load */
window.onload = function(){
    queue = [
        {% for song in songs %}
        {
            file: "{{ url_for('static', filename=song.file_path) }}",
            id: {{ song.id }},
            title: "{{ song.title }}",
            artist: "{{ song.artist_name }}",
            lyrics: "{{ song.lyrics|default('Lyrics not available') }}"
        },
        {% endfor %}
    ];
};

/* Update mini player details */
function updatePlayerInfo(song){
    document.getElementById('playerTitle').textContent = song.title;
    document.getElementById('playerArtist').textContent = song.artist;
    document.getElementById('playerLyrics').textContent = song.lyrics || "Lyrics not available";
}

/* Load and play song */
function loadAndPlay(){
    if(queue.length === 0) return;
    const song = queue[currentIndex];
    const player = document.getElementById("audioPlayer");
    player.src = song.file;
    updatePlayerInfo(song);
    player.play().catch(err => console.log("Play blocked:", err));
    isPlaying = true;
    document.getElementById("playPauseBtn").textContent = '⏸';
    player.onended = () => nextSong();
}

/* Next / Previous */
function nextSong(){
    if(queue.length === 0) return;
    currentIndex = (currentIndex + 1) % queue.length;
    loadAndPlay();
}

function prevSong(){
    if(queue.length === 0) return;
    currentIndex = (currentIndex - 1 + queue.length) % queue.length;
    loadAndPlay();
}

/* Play / Pause */
function togglePlayPause(){
    const player = document.getElementById("audioPlayer");
    if(!queue.length) return;
    if(isPlaying){
        player.pause();
        isPlaying = false;
        document.getElementById("playPauseBtn").textContent = '▶';
    } else {
        player.play().catch(err => console.log("Play blocked:", err));
        isPlaying = true;
        document.getElementById("playPauseBtn").textContent = '⏸';
    }
}

/* Play selected song */
document.querySelectorAll("#recommendedSongs .song-card").forEach(card=>{
    card.onclick = () => {
        currentIndex = queue.findIndex(s => s.id == card.dataset.id);
        loadAndPlay();
    };
});

/* Play playlist */
function playPlaylist(playlistId){
    fetch(`/playlist-songs/${playlistId}`)
        .then(res => res.json())
        .then(data => {
            queue = data.songs.map(s => ({
                file: s.file,
                id: s.id,
                title: s.title,
                artist: s.artist,
                lyrics: s.lyrics || "Lyrics not available"
            }));
            currentIndex = 0;
            loadAndPlay();
        });
}

/* Search songs */
function searchSongs(query){
    const resultsDiv = document.getElementById("searchResults");
    resultsDiv.innerHTML = "";
    if(!query) return;
    fetch(`/search-songs?q=${encodeURIComponent(query)}`)
        .then(res => res.json())
        .then(data => {
            if(data.songs.length === 0){
                resultsDiv.innerHTML = "<p>No results found.</p>";
                return;
            }
            data.songs.forEach(song => {
                const div = document.createElement("div");
                div.className = "song-card";
                div.textContent = song.title + " - " + song.artist;
                div.onclick = () => {
                    queue = [{file:song.file, id:song.id, title:song.title, artist:song.artist, lyrics: song.lyrics || "Lyrics not available"}];
                    currentIndex = 0;
                    loadAndPlay();
                };
                resultsDiv.appendChild(div);
            });
        });
}
function likeSong(songId, btn){
    fetch(`/like-song/${songId}`, {method: 'POST'})
        .then(res => res.json())
        .then(data => {
            if(data.status === 'ok'){
                btn.textContent = `❤️ ${data.likes}`;
            } else {
                alert('Error liking song');
            }
        });
}

</script>

</body>
</html>
